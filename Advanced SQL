--Advance SQL

-- 1) adjusting max packet size to allow large files to run

SET GLOBAL max_allowed_packet = 1073741824;


-- 2) adjusting your SQL mode to allow invalid dates and use a smarter GROUP BY setting

SET GLOBAL SQL_MODE='TRADITIONAL,ALLOW_INVALID_DATES,ONLY_FULL_GROUP_BY';


-- 3) adjusting your timeout settings to run longer queries

SET GLOBAL connect_timeout=28800;

SET GLOBAL wait_timeout=28800;

SET GLOBAL interactive_timeout=28800;

-- The database doesn't load here because it's too massive for github

-- Task 1: Prodcue a breakdown by UTM Source, campaign, and referring domain


-For the Schema in the example

Use mavenfuzzyfactory;

Select * 
  utm_source,
  utm_campaign
  http_referer
  
COUNT(DISTINCT website_session_id) AS number_of_sessions
FROM website_sessions
WHERE created_at < '2012-04-14

GROUP BY
  utm_source,
  utm_campaign
  http_referer
  
ORDER BY number_of_sessions DESC;

--Task 2: Calculate the Conversion Rate from session to order
-- CVR must be at least 4%

Select * 

COUNT(DISTINCT. website_sessions.website_session_id) AS sessions, 
COUNT(DISTINCT. orders.order_id) AS orders
COUNT(DISTINCT. orders.order_id)/ COUNT(DISTINCT. website_sessions.website_session_id) AS sessions_to_order_conv_rt

From website_sessions
  LEFT JOIN orders
    ON orders.wes_session_id = website_sessions.website_session_id

Where website_sessions.creatred_at < '2012-04-14
  AND utm_source = 'gsearch'
  AND utm_campaign = 'nonbrand';
  
  
  --Task 3
  
